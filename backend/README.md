# Gracie Backend (Go + DynamoDB)

Minimal HTTP API for Users and shared Rooms.

## Quick Start (Local)

Environment:

```
export DDB_ENDPOINT=http://localhost:8000
export AWS_REGION=us-east-1 # optional, defaults
export AWS_ACCESS_KEY_ID=local
export AWS_SECRET_ACCESS_KEY=local
export USERS_TABLE=Users
export ROOMS_TABLE=Rooms
export PORT=8080
```

Create tables in DynamoDB Local:

```
aws dynamodb create-table \
  --table-name Users \
  --attribute-definitions AttributeName=user_id,AttributeType=S AttributeName=api_key_lookup,AttributeType=S \
  --key-schema AttributeName=user_id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --global-secondary-indexes 'IndexName=api_key_lookup_index,KeySchema=[{AttributeName=api_key_lookup,KeyType=HASH}],Projection={ProjectionType=ALL}' \
  --endpoint-url $DDB_ENDPOINT --region $AWS_REGION

aws dynamodb create-table \
  --table-name Rooms \
  --attribute-definitions AttributeName=room_id,AttributeType=S \
  --key-schema AttributeName=room_id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --endpoint-url $DDB_ENDPOINT --region $AWS_REGION
```

Run server:

```
go run ./backend/cmd/gracie-server
```

## Docker (One Command)

Using Docker Compose to start DynamoDB Local, the API, and the Frontend together:

```
docker compose up --build
```

Details:
- `dynamodb` exposes `8000` on host and persists data under `./.dynamodb`.
- `api` builds the Go binary, runs a small entrypoint that provisions tables via `setup-ddb`, then starts the server on `8080`.
- Environment is wired for local defaults inside the compose file (`DDB_ENDPOINT=http://dynamodb:8000`, `USERS_TABLE=Users`, `ROOMS_TABLE=Rooms`).
- `frontend` builds the React app and serves it via Nginx on `http://localhost:3000`. Nginx proxies `/api/*` to the `api` container, so no CORS is required.

Stop everything:

```
docker compose down
```

Rebuild after code changes:

```
docker compose build api frontend && docker compose up api frontend
```

## New Endpoints and Behavior

Auth
- POST `/auth/register` (public): `{ username(email), password, name? }` → 201 Created.
- POST `/auth/login` (public): `{ username, password }` → `{ user, api_key }`. API key is rotated on login.

Rooms
- POST `/rooms/join`: `{ token }` → joins by 5‑char share code only (no room ID required).
- PUT `/rooms/settings`: `{ display_name?, description? }` → updates settings for caller’s room. Display name: alphanumeric + spaces, <= 64 chars. Description: <= 512 chars; empty string removes.
- GET `/rooms/me`: Returns a sanitized view `{ display_name, description, members, created_at, updated_at }` (no internal IDs).

Share Codes
- 5‑character, URL‑safe, alphanumeric codes excluding I/O/L. Generated by `ids.NewShareToken5()`.

## DynamoDB Tables / Indexes

Users
- PK: `user_id`
- GSIs:
  - `api_key_lookup_index` on `api_key_lookup`
  - `username_index` on `username`

Rooms
- PK: `room_id`
- GSI:
  - `share_token_index` on `share_token`

Notes
- When adding GSIs to existing local tables, `setup-ddb` ensures `AttributeDefinitions` are included to satisfy DynamoDB Local; otherwise it errors with “No Attribute Schema Defined”.
- Model tags use `omitempty` to avoid invalid empty string/null writes on attributes (e.g., `room_id`, `share_token`, `description`).

## Auth

Uses API key issued at signup. Send header `Authorization: Bearer <api_key>` on all endpoints except `POST /users`.

## Endpoints

- POST `/users` (public): `{ name }` → creates user and a solo room. Returns `{ user, api_key }` (key shown once).
- GET `/me`: returns the authenticated user.
- PUT `/me`: update `{ name }`.
- GET `/rooms/me`: returns current room; `404` if none.
- POST `/rooms`: create solo room if none; `409` if already in one.
- POST `/rooms/share`: rotate share token, returns `{ room_id, token }`.
- POST `/rooms/{room_id}/join`: body `{ token }` → join as second member. If joiner has a solo room, it is deleted atomically. Errors: `403` (bad token), `409` (room full, or joiner already in 2-person room).
- POST `/rooms/deletion/vote`: record vote; when both members have voted, deletes room and clears both users’ `room_id`. Response `{ deleted: true|false }`.
- POST `/rooms/deletion/cancel`: cancels caller’s vote.

## Notes

- After deletion, users are left without a room (must call `POST /rooms` to create a new solo room).
- API keys are stored as bcrypt hashes, and a deterministic SHA-256 lookup (`api_key_lookup`) is used via GSI to find the user.
